const e=e=>3*(255&e)+5*(e>>>8&255)+7*(e>>>16),t=(e,t,a)=>3*e+5*t+7*a;for(let e=1;e<=3;e++)try{self.importScripts(`${baseUrl}/lib/lz4/lz4_decoder.js`);break}catch(t){self.postMessage({type:"warn",message:`[LZ4-Worker] Attempt ${e} of 3 to import lz4_decoder has failed: ${t.message}`})}function a(a,s,r,o){const f=new DataView(a.buffer,a.byteOffset),l=new DataView(r.buffer,r.byteOffset),i=new Uint32Array(64);let n=0,d=0,u=0;for(let a=0;a<o;a+=3){if(d>0)d--;else if(n<s){const a=f.getUint32(n++,!0),s=255&a;if(255===s)n+=3,u=a>>>8,i[63&e(u)]=u;else{const e=192&s;if(0===e)u=i[s];else if(64===e){let e=255&u,s=u>>>8&255,r=u>>>16;e=e+(a>>>4&3)-2&255,s=s+(a>>>2&3)-2&255,r=r+(3&a)-2&255,u=e|s<<8|r<<16,i[63&t(e,s,r)]=u}else d=127&s}}l.setUint32(a,u<<8,!1)}}"undefined"==typeof Module&&(self.postMessage({type:"error",message:"[LZ4-Worker] Could not import lz4_decoder so lz4decoder-worker will be shut down"}),self.close()),self.frameCount=0,self.totalFrameDecodingTime=0,self.onmessage=function(e){switch(e.data.type){case"frame":let t,s,r,o,f,l,i=(new Date).getTime(),n=e.data.frame.byteLength,d=e.data.isQoi,u=e.data.maxSize,m=!0,c=new Uint8Array(e.data.frame);if(e.data.frame=null,e.data.clips){const i=new Uint32Array(e.data.clips),g=i.length>>2;e.data.clips=null,f=new Uint8Array(e.data.output),e.data.output=null,s=Module._malloc(n+u),o=new Uint8Array(Module.HEAPU8.buffer,s,u),r=new Uint8Array(Module.HEAPU8.buffer,s+u,n),r.set(new Uint8Array(c.buffer)),c=null;for(let e=0;e<g;e++){const t=i[4*e],r=i[4*e+1],n=i[4*e+2],c=i[4*e+3];if(l=_LZ4_decompress_safe(s+u+t,s,r,u),d){if(l<0){self.postMessage({type:"info",message:"[LZ4-Worker] Error in worker: decodedSize ("+l+") must be positive!!!"}),m=!1;break}a(o,l,f.subarray(n,n+c+1),c)}else{if(l!==c){self.postMessage({type:"info",message:`[LZ4-Worker] Error in worker: decodedSize (${l} is different than expected one (${c})`}),m=!1;break}f.set(o.subarray(0,c),n)}}Module._free(s),t=(new Date).getTime(),o=null,self.postMessage({type:"frame",buffer:f.buffer,ok:m},[f.buffer])}else{let i,m=e.data.width,g=e.data.height;if(i=e.data.isRgb?3*m*g:m*(g+g/2),u=d?4*m*g+3:i,s=Module._malloc(n+u),o=new Uint8Array(Module.HEAPU8.buffer,s,u),r=new Uint8Array(Module.HEAPU8.buffer,s+u,n),r.set(new Uint8Array(c.buffer)),c=null,l=_LZ4_decompress_safe(s+u,s,n,u),Module._free(s),t=(new Date).getTime(),l<0)self.postMessage({type:"info",message:"[LZ4-Worker] Error in worker: decodedSize ("+l+") must be positive!!!"}),o=null;else{if(d){let t=new Uint8Array(i+1);a(o,l,t,i),o=e.data.usingWebGLDecoder?t:t.buffer,l=i,t=null}if(e.data.usingWebGLDecoder)f=new Uint8Array(o);else{f=new Uint8ClampedArray(m*g*4);for(let e=0,t=0;t<l;t+=3)f[e]=o[t],f[e+1]=o[t+1],f[e+2]=o[t+2],f[e+3]=255,e+=4}o=null,self.postMessage({type:"frame",buffer:f,width:m,height:g,x:e.data.x,y:e.data.y,decodedSize:l},[f.buffer])}}self.frameCount++,self.totalFrameDecodingTime+=t-i;break;case"stats":self.postMessage({type:"stats",frameCount:self.frameCount,totalFrameDecodingTime:self.totalFrameDecodingTime,averageDecodingTime:self.totalFrameDecodingTime/self.frameCount,averageDecodingFPS:self.frameCount/(self.totalFrameDecodingTime/1e3)}),self.frameCount=0,self.totalFrameDecodingTime=0;break;case"close":self.postMessage({type:"info",message:"Closing LZ4 worker"}),self.close()}};